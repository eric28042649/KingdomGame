# AI 王國策略遊戲 (AI Kingdom Strategy Game)

這是一個基於網頁的單人策略遊戲，玩家扮演一位奇幻王國的統治者，透過對 AI 生成的事件做出選擇，來管理王國的四項核心資源（人民、軍隊、金庫、信仰），目標是維持資源平衡，盡可能長久地統治下去。

## ✨ 主要特色

- **AI 驅動的動態事件**：遊戲內容（王國背景、事件、選項、結果）由 Google Gemini 大型語言模型動態生成，提供豐富多變的遊戲體驗。
- **策略性資源管理**：玩家需要在四項核心資源之間取得平衡，任何資源歸零或滿溢都可能導致遊戲結束。
- **奇幻世界觀**：事件和描述融入了豐富的奇幻元素，包含魔法、神話生物、奇幻種族與地點等。
- **預生成結果，即時反饋 (v6.1)**：為了提升流暢度，AI 會預先生成每個選項的結果描述。玩家點擊選項後，結果會立即顯示，無需等待後端處理。
- **上下文連貫性**：AI 會參考王國背景設定和有限的遊戲歷史，以生成更具連貫性的事件。
- **多階段事件**：遊戲包含多回合的連續事件，提供更深入的故事線。

## 🛠️ 技術棧

- **前端**:
    - Vanilla JavaScript (ES6 Modules)
    - HTML5
    - CSS3 (基礎樣式，可擴展)
    - `marked.js` (用於將 AI 生成的 Markdown 文本渲染為 HTML)
- **後端**:
    - Cloudflare Workers (用於部署無伺服器後端邏輯)
- **AI 模型**:
    - Google Gemini API (目前配置為 `gemini-1.5-pro-latest` 或相容模型)

## 🏗️ 架構概覽

本專案採用前後端分離的架構：

- **後端 (Cloudflare Worker - `worker.js`)**:
    - 擔任「遊戲主持人」(Game Master) 的角色。
    - 負責與 Gemini API 交互，根據前端請求生成遊戲內容（王國背景、事件描述、選項文本、**每個選項的預生成結果描述**、資源變化效果）。
    - **不處理**遊戲狀態計算（如資源增減、回合推進、勝負判斷）。
    - 接收前端傳來的上下文（王國背景、上回合選擇、當前狀態、歷史記錄）。
    - 以特定 JSON 格式回傳生成的內容。
- **前端 (瀏覽器端 JS/HTML/CSS)**:
    - 負責遊戲主邏輯、流程控制、狀態管理和 UI 渲染。
    - **`main.js`**: 核心控制器，處理頁面路由、遊戲流程（開始、選擇、顯示結果、請求下一事件）。
    - **`api.js`**: 處理與後端 Worker 的通訊。
    - **`game-logic.js`**: 執行前端的遊戲規則計算（資源變化應用、遊戲結束判斷）。
    - **`state.js`**: 使用 `sessionStorage` 管理遊戲狀態和歷史記錄的存儲與讀取。
    - **`ui.js`**: 更新 DOM 元素，顯示遊戲信息，實現打字機等視覺效果。
    - **HTML 文件**: 定義各個遊戲畫面的結構（開始、主遊戲、回饋、結束）。

## 🚀 運作流程 (v6.1)

1. **遊戲開始**:
    - 前端請求後端 (`generateBackground`) 獲取王國背景描述。
    - 前端再次請求後端 (`generateFirstEvent`)，傳遞背景，獲取包含**預生成結果**的第一個事件數據。
    - 前端儲存初始狀態（回合 1，初始資源，第一個事件數據，王國背景）。
2. **玩家回合**:
    - 前端 (`ui.js`) 顯示當前事件描述和選項文字。
    - 玩家點擊一個選項。
    - 前端 (`main.js`) **立即**從儲存的事件數據中提取該選項對應的 `resourceChanges` 和 `outcomeText`。
    - 前端 (`game-logic.js`) 計算新的資源值並檢查遊戲是否結束。
    - 前端 (`main.js`) 將包含事件描述的玩家選擇和結果存入歷史記錄 (`state.js`)。
    - 前端導航到回饋畫面。
3. **回饋與下一事件**:
    - 前端 (`ui.js`) 顯示預生成的 `outcomeText` 和資源變化。
    - 玩家點擊「繼續」按鈕。
    - **如果遊戲未結束**:
        - 前端 (`main.js`) **請求後端** (`generateNextEvent`)，傳遞上回合選擇、當前狀態（資源、回合數）、王國背景和歷史記錄。
        - 後端 (`worker.js`) 生成**下一回合**的完整事件數據（包含所有選項的預生成結果），並返回給前端。
        - 前端 (`main.js`) 儲存新的事件數據到遊戲狀態 (`state.js`)。
        - 前端導航回主遊戲畫面，顯示新事件。
    - **如果遊戲已結束**:
        - 前端導航到遊戲結束畫面。

## ⚙️ 設定與部署

1. **後端 (Cloudflare Worker)**:
    - 需要一個 Cloudflare 帳號。
    - 使用 Wrangler CLI 或 Cloudflare 儀表板部署 `worker.js`。
    - 在 Worker 的環境變數中設定 `GEMINI_API_KEY`，值為您的 Google Gemini API 金鑰。
    - 記下部署後 Worker 的 URL。
2. **前端**:
    - 修改 `js/config.js` 文件中的 `WORKER_URL` 常數，將其值替換為您部署的 Cloudflare Worker URL。
    - 將前端的 HTML、CSS 和 JavaScript 文件部署到任何靜態網站託管服務（如 GitHub Pages, Netlify, Vercel, 或您自己的伺服器）。

## 📁 文件結構

```
.
├── index.html                # 開始畫面
├── main-game.html            # 主遊戲畫面
├── feedback-screen.html      # 回饋畫面
├── game-over-screen.html     # 遊戲結束畫面
├── css/
│   └── style.css             # 主要樣式表
├── js/
│   ├── main.js               # 前端主邏輯與流程控制
│   ├── api.js                # 後端 API 通訊
│   ├── config.js             # 遊戲設定常數
│   ├── game-logic.js         # 核心遊戲規則計算
│   ├── state.js              # 遊戲狀態存儲與讀取
│   └── ui.js                 # UI 更新與效果
├── worker.js                 # Cloudflare Worker 後端腳本
└── README.md                 # 本文件

```
